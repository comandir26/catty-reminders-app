name: Deployment

on:
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Deploy Docker container
      run: |
        ssh -p 2200 -o StrictHostKeyChecking=no vlad@course.prafdin.ru '
          set -e
          echo "Starting Docker container deployment..."
          
          # –õ–æ–≥–∏–Ω–∏–º—Å—è –≤ GitHub Container Registry
          echo "${{ secrets.DOCKER_PAT }}" | docker login ghcr.io -u comandir26 --password-stdin
          
          echo "Pulling latest Docker image..."
          docker pull ghcr.io/comandir26/catty-app:latest
          
          echo "Checking existing containers..."
          docker ps -a
          
          echo "Stopping and removing existing container..."
          # –£–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ)
          docker rm -f catty-container 2>/dev/null  echo "No container to remove"
          
          echo "Starting new container..."
          docker run -d \
            --name catty-container \
            --restart unless-stopped \
            -p 8181:8181 \
            ghcr.io/comandir26/catty-app:latest
          
          echo "Waiting for container to start..."
          sleep 10
          
          # –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê
          echo "=== DIAGNOSTICS ==="
          echo "1. Docker containers:"
          docker ps -a
          
          echo "2. Container logs:"
          docker logs catty-container
          
          echo "3. Port listening:"
          netstat -tulpn | grep 8181  echo "Port 8181 not listening"
          
          echo "4. Process in container:"
          docker exec catty-container ps aux  echo "Cannot check processes"
          
          echo "5. Local health check:"
          curl -f http://localhost:8181 && echo "‚úÖ Local health check PASSED"  echo "‚ùå Local health check FAILED"
          
          echo "‚úÖ Deployment completed!"
          echo "üöÄ App should be available at: https://app.volkovvs.course.prafdin.ru"
        '