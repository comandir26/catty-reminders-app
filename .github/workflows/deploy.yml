name: Deployment

on:
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Deploy Docker container
      run: |
        ssh -p 2200 -o StrictHostKeyChecking=no vlad@course.prafdin.ru '
          set -e
          echo "Starting Docker container deployment..."
          
          # Логинимся в GitHub Container Registry
          echo "${{ secrets.DOCKER_PAT }}" | docker login ghcr.io -u comandir26 --password-stdin
          
          echo "Pulling latest Docker image..."
          docker pull ghcr.io/comandir26/catty-app:latest
          
          echo "Stopping existing container..."
          docker stop catty-container  true
          docker rm catty-container  true
          
          echo "Starting new container..."
          docker run -d \
            --name catty-container \
            --restart unless-stopped \
            -p 8181:8181 \
            ghcr.io/comandir26/catty-app:latest
          
          echo "Waiting for container to start..."
          sleep 5
          
          # Проверяем что контейнер запущен
          if docker ps | grep -q catty-container; then
            echo "Deployment completed successfully!"
            echo "App is available at: https://app.volkovvs.course.prafdin.ru"
            
            # Проверяем здоровье приложения
            echo "Checking application health..."
            sleep 3
            curl -f http://localhost:8181 > /dev/null 2>&1 && echo "✅ Application is healthy"  echo "⚠️  Health check failed but container is running"
          else
            echo "Container failed to start"
            docker logs catty-container  echo "No logs available"
            exit 1
          fi
          
          echo "Cleaning up unused images..."
          docker image prune -f
        '