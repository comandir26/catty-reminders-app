name: Deployment

on:
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Deploy
      run: |
        ssh -p 2200 -o StrictHostKeyChecking=no vlad@course.prafdin.ru '
          set -e
          echo "Starting deployment via FRP..."
          
          echo "‚èπStopping application service..."
          sudo systemctl stop catty-app.service || echo "Service was not running"
          
          echo "Pulling latest changes..."
          cd /home/vlad/catty-reminders-app
          
          git fetch --all
          
          echo "Available branches:"
          git branch -a
          
          git checkout github-actions
          git pull origin github-actions
          
          echo "Installing dependencies..."
          ./venv/bin/pip install -r requirements.txt
          
          echo "Starting application service..."
          sudo systemctl daemon-reload
          sudo systemctl start catty-app.service
          
          sleep 3
          if sudo systemctl is-active --quiet catty-app.service; then
            echo "Deployment completed successfully!"
          else
            echo "Application failed to start"
            sudo systemctl status catty-app.service --no-pager
            exit 1
          fi
        '