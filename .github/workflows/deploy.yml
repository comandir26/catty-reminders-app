name: Deployment

on:
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Deploy Docker container
      run: |
        ssh -p 2200 -o StrictHostKeyChecking=no vlad@course.prafdin.ru '
          set -e
          echo "Starting Docker container deployment..."
          
          # Логинимся в GitHub Container Registry
          echo "${{ secrets.DOCKER_PAT }}" | docker login ghcr.io -u comandir26 --password-stdin
          
          echo "Pulling latest Docker image..."
          docker pull ghcr.io/comandir26/catty-app:latest
          
          echo "Stopping existing container..."
          docker stop catty-container 2>/dev/null  echo "No container to stop"
          docker rm catty-container 2>/dev/null  echo "No container to remove"
          
          echo "Starting new container..."
          docker run -d \
            --name catty-container \
            --restart unless-stopped \
            -p 8181:8181 \
            ghcr.io/comandir26/catty-app:latest
          
          echo "Waiting for container to start..."
          sleep 10
          
          echo "=== DIAGNOSTICS ==="
          echo "1. Docker containers:"
          docker ps -a
          
          echo "2. Container logs:"
          docker logs catty-container
          
          echo "3. Port listening:"
          netstat -tulpn | grep 8181  echo "Port 8181 not listening"
          
          echo "4. Local health check:"
          curl -f http://localhost:8181 && echo "Local health check PASSED"  echo "Local health check FAILED"
          
          echo "Deployment completed!"
          echo "App should be available at: https://app.volkovvs.course.prafdin.ru"
        '